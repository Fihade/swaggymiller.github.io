<!DOCTYPE html>
<html>
  <head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport">
  <title>MillerLiang</title>
  <link rel="shortcut icon" href="/images/favicon.ico">
  <!-- Jquery -->
  <script src="https://cdn.jsdelivr.net/jquery/2.1.3/jquery.min.js"></script>
  <!-- Google Fonts -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Noto+Sans+SC:400,700|Roboto+Condensed:700">
  <!-- prettify -->
  <link rel="stylesheet" href="/prettify/atelier-sulphurpool-light.min.css">
  <script src="/prettify/prettify.js"></script>

  <link rel="stylesheet" href="/css/style.css">
  <script src="/js/script.js"></script>
</head>
  <body>
    <div class="container">
    
      <header>
  <div class="header">
    <div class="blog-title">
      <a href="/" class="logo">MillerLiang</a>
    </div>
    <nav class="navbar hidden-xs-only">
      <ul class="menu">
        
          <li class="menu-item">
            <a href="/" class="menu-item-link">Home</a>
          </li>
        
          <li class="menu-item">
            <a href="/archives" class="menu-item-link">Archives</a>
          </li>
        
          <li class="menu-item">
            <a href="https://github.com/swaggymiller" class="menu-item-link">Github</a>
          </li>
        
      </ul>
    </nav>
  </div>

  <nav class="header-nav hidden-sm-and-up">
    <ul class="menu">
      
        <li class="menu-item">
          <a href="/" class="menu-item-link">Home</a>
        </li>
      
        <li class="menu-item">
          <a href="/archives" class="menu-item-link">Archives</a>
        </li>
      
        <li class="menu-item">
          <a href="https://github.com/swaggymiller" class="menu-item-link">Github</a>
        </li>
      
    </ul>
  </nav>
  
</header>
      <main class="main">
        <article class="post">
  <div class="post-title">
    <h2 class="title">ğŸˆFlutterå“åº”å¼ç¼–ç¨‹â€”â€” BLoCæ¨¡å¼</h2>
  </div>
   <div class="post-meta">
    <span class="post-time">2019-04-21</span>
    <span class="post-author">æ¢æ–Œ</span>
  </div>
  <div class="post-content">
    <p>BLoCæ¨¡å¼æ˜¯åœ¨2018DartConfæœŸé—´ç¬¬ä¸€æ¬¡å±•ç¤ºï¼Œä½ å¯ä»¥åœ¨æœ‰æ¡ä»¶çš„æƒ…å†µä¸‹è®¿é—®[è¿™é‡Œ]: (<a href="https://www.youtube.com/watch?v=PLHln7wHgPE" target="_blank" rel="noopener">https://www.youtube.com/watch?v=PLHln7wHgPE</a> â€œè¿™é‡Œâ€)ã€‚</p>
<p>BLoçš„å«ä¹‰æ˜¯â€œBussiness Logic Componentâ€,ç¿»è¯‘è¿‡æ¥å°±æ˜¯ä¸šåŠ¡é€»è¾‘ç»„ä»¶ï¼Œé€šè¿‡å®è·µè¯æ˜å®ƒå…·æœ‰ä»¥ä¸‹å‡ ä¸ªç‰¹æ€§ï¼š</p>
<ul>
<li>ä½ å¯èƒ½éœ€è¦ä¸€ä¸ªæˆ–å¤šä¸ªBLoC</li>
<li>UIçš„ç»„ä»¶åªå…³å¿ƒäº‹åŠ¡å±‚å¹¶ä¸å…³å¿ƒä¸šåŠ¡å±‚</li>
<li>æˆ‘ä»¬éœ€è¦ä¸€ä¸ªèƒ½è¿æ¥BLocçš„Streamï¼Œé€šè¿‡å®ƒçš„è¾“å…¥(Sink)å’Œè¾“å‡º(Streams)ï¼Œè¿›è¡Œé€šä¿¡</li>
<li>å„éƒ¨åˆ†ç›¸å¯¹ç‹¬ç«‹ï¼Œæ¨¡å—åŒ–çš„æ„Ÿè§‰çœŸçš„å¾ˆæœ‰æ„æ€ï¼ˆä½è€¦åˆï¼‰</li>
</ul>
<p>æ‰€ä»¥æˆ‘ä»¬éœ€è¦å‰æœŸå…ˆè¦äº†è§£ä¸€äº›æ¦‚å¿µï¼š</p>
<ol>
<li>ä»€ä¹ˆæ˜¯å“åº”å¼ç¼–ç¨‹ï¼Ÿ</li>
</ol>
<p>å“åº”å¼ç¼–ç¨‹æ˜¯ä½¿ç”¨å¼‚æ­¥æ•°æ®æµçš„ç¼–ç¨‹ï¼Œå³å½“ä½ è§¦å‘ä¸€æ¬¡äº‹ä»¶ï¼Œä½ çš„æ‰€æœ‰çš„æ•°æ®ã€çŠ¶æ€éƒ½æ˜¯é€šè¿‡æ•°æ®æµè¿›è¡Œæ”¹å˜çš„ï¼Œä¼šå­˜åœ¨ç›‘å¬äº‹ä»¶å¯¹è§¦å‘äº‹ä»¶è¿›è¡Œç›‘å¬å¹¶äº§ç”Ÿç›¸å¯¹åº”çš„åé¦ˆã€‚åœ¨Flutteä¸­ï¼Œæƒ³è¦å®ç°å“åº”å¼ç¼–ç¨‹æˆ‘ä»¬éœ€è¦Streamå’Œlistenersè¿›è¡Œå¼€å‘ï¼Œè§¦å‘äº‹ä»¶éœ€è¦å‘Streamè¿›è¡Œå‘é€é€šçŸ¥ï¼Œç„¶åä¼ åˆ°BLoCï¼Œè¿›è¡Œäº‹ä»¶å¤„ç†ã€‚<br>
2. ä»€ä¹ˆæ˜¯Stream?</p>
<p>Streamä½ å¯ä»¥çœ‹æˆä¸€ä¸ªæ•°æ®ç®¡é“ï¼Œå½“ä½ è¾“å…¥æ•°æ®æäº¤ä¹‹åï¼Œå°±ä¼šä»å¦ä¸€ç«¯è¾“å‡ºæ•°æ®</p>
<p>å‡è®¾æˆ‘ä»¬ä½¿ç”¨ä¼ ç»Ÿçš„æ–¹å¼è¿›è¡Œäº¤äº’ï¼Œæˆ‘ä»¬éœ€è¦åœ¨æ¯æ¬¡è§¦å‘äº‹ä»¶è¿›è¡Œä¸€æ¬¡SetState(() {}),éšç€ä½ å¯èƒ½åŠŸèƒ½çš„ä¸æ–­å¢åŠ ï¼ŒsetStateçš„æ¬¡æ•°ä¸æ–­å¢åŠ ï¼Œç½‘ç»œè¯·æ±‚å’ŒUIå†™åœ¨ä¸€èµ·ï¼Œåæ¥ç¨‹åºå°†å˜å¾—ç‰¹åˆ«å¤æ‚ï¼Œä¾‹å¦‚ï¼š</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Future&lt;<span class="built_in">Null</span>&gt; _handleRefresh() <span class="keyword">async</span>&#123;</span><br><span class="line">  <span class="keyword">await</span> Future.delayed(<span class="built_in">Duration</span>(seconds: <span class="number">1</span>));</span><br><span class="line">  setState(() &#123;&#125;);</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å½“é‡‡ç”¨BLoCæ¨¡å¼çš„æ—¶å€™</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> MovieProvider(</span><br><span class="line">      movieBloc: MovieBloc(API()),</span><br><span class="line">      child: MaterialApp(</span><br><span class="line">        title: <span class="string">'Flutter Demo'</span>,</span><br><span class="line">        theme: ThemeData(),</span><br><span class="line">        home: MyHomePage(),</span><br><span class="line">      ),</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<p>é€šè¿‡StreamBuilderæ„å»ºç»„ä»¶</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Flexible(</span><br><span class="line"> child: StreamBuilder(</span><br><span class="line">   stream: movieBloc.results,</span><br><span class="line">       builder: (context, snapshot) &#123;</span><br><span class="line">         <span class="keyword">if</span> (!snapshot.hasData)</span><br><span class="line">       &#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨BLoCä¸­å®šä¹‰æ•°æ®</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Stream&lt;<span class="built_in">List</span>&lt;Movie&gt;&gt; _results = Stream.empty();</span><br><span class="line">Stream&lt;<span class="built_in">String</span>&gt; _log = Stream.empty();</span><br><span class="line"></span><br><span class="line">ReplaySubject&lt;<span class="built_in">String</span>&gt; _query = ReplaySubject&lt;<span class="built_in">String</span>&gt;();</span><br><span class="line"></span><br><span class="line">Stream&lt;<span class="built_in">String</span>&gt; <span class="keyword">get</span> log =&gt; _log;</span><br><span class="line">Stream&lt;<span class="built_in">List</span>&lt;Movie&gt;&gt; <span class="keyword">get</span> results =&gt; _results;</span><br><span class="line">Sink&lt;<span class="built_in">String</span>&gt; <span class="keyword">get</span> query =&gt; _query;</span><br></pre></td></tr></table></figure>
<p>é€šè¿‡BLoCè‡ªèº«è¿›è¡Œæ•°æ®å¤„ç†</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">MovieBloc(<span class="keyword">this</span>.api) &#123;</span><br><span class="line">  _results = _query.distinct().asyncMap(api.<span class="keyword">get</span>).asBroadcastStream();</span><br><span class="line"></span><br><span class="line">  _log = Observable(results)</span><br><span class="line">      .withLatestFrom(_query.stream, (_, query) =&gt; <span class="string">'Results for $query'</span>)</span><br><span class="line">      .asBroadcastStream();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æœ€åæˆ‘ä»¬éœ€è¦ä¸€ä¸ªProviderè¿›è¡Œæ•°æ®çš„å°è£…</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MovieProvider</span> <span class="keyword">extends</span> <span class="title">InheritedWidget</span> </span>&#123;</span><br><span class="line">  <span class="keyword">final</span> MovieBloc movieBloc;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  <span class="built_in">bool</span> updateShouldNotify(InheritedWidget oldWidget) =&gt; <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">static</span> MovieBloc of(BuildContext context) =&gt;</span><br><span class="line">      (context.inheritFromWidgetOfExactType(MovieProvider) <span class="keyword">as</span> MovieProvider)</span><br><span class="line">          .movieBloc;</span><br><span class="line"></span><br><span class="line">  MovieProvider(&#123;Key key, MovieBloc movieBloc, Widget child&#125;)</span><br><span class="line">      : <span class="keyword">this</span>.movieBloc = movieBloc ?? MovieBloc(API()),</span><br><span class="line">        <span class="keyword">super</span>(child: child, key: key);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ³¨æ„äº‹é¡¹ï¼š</p>
<ol>
<li>ä¸¥é‡éµå®ˆäº†å•ä¸€èŒè´£åŸåˆ™ï¼Œä»£ç è§£è€¦æ›´å¥½</li>
<li>ä¸ä¸€å®šä»»ä½•æ—¶å€™éƒ½è¦ç”¨BLoCæ¨¡å¼ï¼Œä¸è¦ä¸ºäº†æ¨¡å¼è€Œæ¨¡å¼</li>
<li>ç”¨äº†BLoCä¹‹åæ›´å®¹æ˜“æµ‹è¯•ï¼Œæ¨¡å—åŒ–æ¯æ¬¡æµ‹è¯•æ¯”æ··èµ·æ¥å†™èˆ’æœå¤šäº†</li>
<li>ä½¿ç”¨åœºæ™¯å¯èƒ½å½“ä½ ä¸åŒçš„UIç»„ä»¶éœ€è¦åŒä¸€ä»½æ•°æ®çš„æ—¶å€™ï¼Œæ˜¾ç„¶BLoCåœ¨å…¶ä¸­çš„ä½œç”¨å°±ä¼šååˆ†æ˜æ˜¾</li>
</ol>

  </div>
</article>
      </main>
    </div>
  <script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [ ["$","$"], ["\\(","\\)"] ],
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'],
            processEscapes: true
        }
    });
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax();
        for (var i = 0; i < all.length; ++i)
            all[i].SourceElement().parentNode.className += ' has-jax';
    });
</script>
<!-- <script src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script> -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML"></script>
</body>
</html>